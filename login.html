<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å¾“æ¥­å“¡ãƒ­ã‚°ã‚¤ãƒ³</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  
  <style>
    /* ã‚¹ã‚­ãƒ£ãƒŠãƒ¼UIå…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    #qr-reader-container {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: black; z-index: 9999; display: flex;
      align-items: center; justify-content: center;
    }
    
    /* å®Ÿéš›ã®ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ */
    #qr-reader { width: 100%; height: 100%; border: none !important; }
    #qr-reader video { width: 100% !important; height: 100% !important; object-fit: cover; }

    /* ã‚¬ã‚¤ãƒ‰ã®ä¸­å¤®ã‚’èµ°ã‚‹èµ¤ã„ç·š */
    .scanner-line-overlay {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      height: 3px; background-color: red; z-index: 2;
      pointer-events: none;
      /* JSã§ã®å¹…æŒ‡å®šã«å¯¾å¿œã§ãã‚‹ã‚ˆã†æœ€å¤§å¹…ã‚‚åºƒã’ã‚‹ */
      max-width: 90vw; 
    }

    /* èµ¤ã„ç·šã®ä¸¡ç«¯ã«ã‚ã‚‹ç·‘è‰²ã®ç‚¹ */
    .scanner-line-overlay::before, .scanner-line-overlay::after {
      content: ''; position: absolute; top: 50%;
      transform: translateY(-50%); width: 12px; height: 12px;
      background-color: #00b050; border-radius: 50%;
    }
    .scanner-line-overlay::before { left: -6px; }
    .scanner-line-overlay::after { right: -6px; }

    /* ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ */
    #close-scanner-btn {
      position: absolute; bottom: 10vh; left: 50%;
      transform: translateX(-50%); z-index: 3;
      padding: 10px 20px; background-color: white; color: black;
      font-weight: bold; border: none; border-radius: 4px; cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
    <h1 class="text-2xl font-bold mb-6 text-center">å¾“æ¥­å“¡ãƒ­ã‚°ã‚¤ãƒ³</h1>

    <!-- ğŸ”· å¾“æ¥ã®ãƒ­ã‚°ã‚¤ãƒ³ -->
    <label class="block mb-2 font-semibold">ID</label>
    <input id="employee-id" type="text" class="w-full mb-4 px-4 py-2 border rounded-md" placeholder="å¾“æ¥­å“¡ID">
    <label class="block mb-2 font-semibold">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
    <input id="employee-password" type="password" class="w-full mb-6 px-4 py-2 border rounded-md" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button onclick="manualLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-md">
      å¾“æ¥ã®IDã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>
    
    <!-- åŒºåˆ‡ã‚Šç·š -->
    <div class="relative flex py-5 items-center">
        <div class="flex-grow border-t border-gray-300"></div>
        <span class="flex-shrink mx-4 text-gray-400 text-sm">ã¾ãŸã¯</span>
        <div class="flex-grow border-t border-gray-300"></div>
    </div>

    <!-- QRã‚³ãƒ¼ãƒ‰/ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³ -->
    <div class="space-y-3">
        <button id="scan-qr-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-2 px-4 rounded-md">
          QRã‚³ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
        <button id="scan-barcode-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white py-2 px-4 rounded-md">
          ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
    </div>

    <!-- Microsoftã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ -->
    <button id="signInMicrosoft" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md mt-5">
      Microsoftã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
    </button>
    <p id="userInfo" class="mt-4 text-sm"></p>
  </div>

  <!-- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®UI -->
  <div id="qr-reader-container" style="display: none;">
    <div id="qr-reader"></div>
    <div class="scanner-line-overlay"></div>
    <button id="close-scanner-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <script>
    // MSAL è¨­å®š
    const msalConfig = {
      auth: { clientId: "c997f97a-5a7f-4ddf-89d4-79f84a1d14fd", authority: "https://login.microsoftonline.com/f26d3362-79fe-4262-817a-531c7cdbf597", redirectUri: "https://misemi-ya.github.io/www.misemi-ya.co.jp/syain.html" },
      cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false }
    };
    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginRequest = { scopes: ["openid", "profile", "User.Read"] };
    
    // å¾“æ¥ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    function manualLogin() {
      const id = document.getElementById("employee-id").value;
      const pw = document.getElementById("employee-password").value;
      if ((id === "012365498827" && pw === "43386592") || (id === "017446484632" && pw === "11969662")) {
        console.log("å¾“æ¥ã®ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ ãƒšãƒ¼ã‚¸é·ç§»ã‚’é–‹å§‹...");
        window.location.href = "syain.html";
      }
    }

    // Microsoftã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    document.getElementById("signInMicrosoft").addEventListener("click", () => msalInstance.loginRedirect(loginRequest));
    msalInstance.handleRedirectPromise().then(response => { if (msalInstance.getActiveAccount()) { console.log("ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ ãƒšãƒ¼ã‚¸é·ç§»ã‚’é–‹å§‹..."); window.location.href = "syain.html"; } }).catch(err => console.error(err));

    // --- ã“ã“ã‹ã‚‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼å‡¦ç† ---

    const qrReaderContainer = document.getElementById('qr-reader-container');
    const closeScannerBtn = document.getElementById('close-scanner-btn');
    const lineOverlay = document.querySelector('.scanner-line-overlay');
    const html5QrCode = new Html5Qrcode("qr-reader");

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®è¨­å®šã‚’2ç¨®é¡ç”¨æ„ (èª­ã¿å–ã‚Šç¯„å›²ã‚’æ‹¡å¤§)
    const qrConfig = { fps: 10, qrbox: { width: 350, height: 350 } };
    const barcodeConfig = { fps: 10, qrbox: { width: 450, height: 200 } };

    // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã®å…±é€šå‡¦ç†
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
      console.log(`ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸ: ${decodedText}`);
      const [id, pw] = decodedText.split(':');
      if (id && pw) {
        document.getElementById('employee-id').value = id;
        document.getElementById('employee-password').value = pw;
        stopScanner();
        manualLogin();
      } else {
        stopScanner();
        alert('ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯ç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ã€ŒID:ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã®å½¢å¼ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
      }
    };

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’èµ·å‹•ã™ã‚‹å…±é€šé–¢æ•°
    function startScanner(config) {
      qrReaderContainer.style.display = 'flex';
      // ã‚¬ã‚¤ãƒ‰ç·šã®å¹…ã‚’ã€èµ·å‹•ã™ã‚‹è¨­å®šã®å¹…ã«åˆã‚ã›ã‚‹
      lineOverlay.style.width = `${config.qrbox.width}px`;

      html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
        .catch(err => {
          alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          console.error("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚", err);
          qrReaderContainer.style.display = 'none';
        });
    }

    // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’åœæ­¢ã™ã‚‹å…±é€šé–¢æ•°
    function stopScanner() {
      html5QrCode.stop().then(ignore => {
        qrReaderContainer.style.display = 'none';
      }).catch(err => {
        console.error("QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", err);
        qrReaderContainer.style.display = 'none';
      });
    }

    // å„ãƒœã‚¿ãƒ³ã«ã€å¯¾å¿œã™ã‚‹è¨­å®šã§ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰²ã‚Šå½“ã¦ã‚‹
    document.getElementById('scan-qr-btn').addEventListener('click', () => {
      startScanner(qrConfig);
    });
    document.getElementById('scan-barcode-btn').addEventListener('click', () => {
      startScanner(barcodeConfig);
    });
    closeScannerBtn.addEventListener('click', stopScanner);

  </script>
</body>
</html>
