<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share Portal | Misemi-ya University</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: #f6f8fc; color: #333; }

        /* ロック画面 */
        #vpn-lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: sans-serif; transition: opacity 0.5s;
        }
        #vpn-checking, #auth-request { font-size: 1.2rem; color: #555; text-align: center; }
        
        /* 403 エラー */
        #vpn-error { display: none; text-align: center; }
        .error-code { font-size: 8rem; font-weight: bold; color: #333; margin: 0; }
        .error-msg { font-size: 1.5rem; color: #666; margin-bottom: 20px; }
        .status-box { background: #f0f0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; color: #555; text-align: left; width: 250px; margin: 0 auto; }

        /* メインコンテンツ */
        #real-content { display: none; opacity: 0; transition: opacity 1s; }

        header { background: #003366; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        
        .file-card {
            background: white; padding: 20px; border-radius: 10px; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s; cursor: pointer;
            text-decoration: none; color: inherit; display: block; height: 100%; box-sizing: border-box;
        }
        .file-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .icon-box { font-size: 3rem; margin-bottom: 10px; color: #5f6368; }
        .file-name { font-weight: bold; margin-bottom: 5px; word-break: break-all; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .file-meta { font-size: 0.8rem; color: #888; }
        
        .upload-area {
            border: 2px dashed #003366; padding: 30px; text-align: center;
            background: #eef2f7; border-radius: 10px; margin-bottom: 30px; cursor: pointer; transition: 0.2s;
        }
        .upload-area:hover { background: #e0e5ea; }
        
        .vpn-badge {
            background: #28a745; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        
        .google-btn {
            margin-top: 20px; background: #fff; border: 1px solid #dadce0; color: #3c4043;
            padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .google-btn:hover { background: #f8f9fa; }
    </style>
</head>
<body>

    <!-- ロック画面 (VPNチェック & Google認証) -->
    <div id="vpn-lock-screen">
        <div id="vpn-checking">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Security Checking...
        </div>

        <div id="auth-request" style="display:none;">
            <h2>Drive Authentication</h2>
            <p>VPN接続を確認しました。<br>ファイルを表示するにはGoogleドライブへのアクセスを許可してください。</p>
            <button class="google-btn" onclick="handleAuth()">
                <i class="fa-brands fa-google" style="color:#DB4437;"></i> Google Driveに接続
            </button>
        </div>

        <div id="vpn-error">
            <div class="error-code">403</div>
            <div class="error-msg">Access Denied</div>
            <p style="color:#888;">Please connect via the specified VPN network.</p>
            <div class="status-box">
                <div style="display:flex; justify-content:space-between;">
                    <span>Your IP:</span><span id="user-ip" style="font-weight:bold;">...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div id="real-content">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <a href="l.html" style="color:white; text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> 戻る</a>
                <h2>Share Portal</h2>
            </div>
            <span class="vpn-badge"><i class="fa-solid fa-shield-halved"></i> SECURE CONNECTION</span>
        </header>

        <div class="container">
            <!-- アップロードボタン (実際はGoogleドライブを開く) -->
            <div class="upload-area" onclick="window.open('https://drive.google.com/drive/my-drive', '_blank')">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem; color:#003366;"></i>
                <h3>ファイルをアップロード / 管理</h3>
                <p>Googleドライブを直接開いてファイルを操作します</p>
            </div>

            <h3 style="border-bottom:2px solid #ddd; padding-bottom:10px;">
                <i class="fa-brands fa-google-drive"></i> マイドライブ (ルートフォルダ)
            </h3>
            
            <div class="file-grid" id="drive-files">
                <div style="grid-column: 1/-1; text-align:center; padding:20px; color:#888;">
                    <i class="fa-solid fa-spinner fa-spin"></i> ファイルを読み込み中...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  設定エリア
        // ==========================================
        const VPN_HOST = 'public-vpn-129.opengw.net';
        
        // ▼▼▼ Google Client ID をここに入れてください ▼▼▼
        const CLIENT_ID = '385803166778-kg041ijpug65vf8ir68tubl8v804ncef.apps.googleusercontent.com';
        
        // Google Drive 読み取り権限
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

        // ==========================================
        //  処理ロジック
        // ==========================================
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // 1. ページ読み込み時にVPNチェック開始
        window.onload = () => {
            verifyConnection();
        };

        // IPアドレスのサブネット抽出
        function getSubnet(ip) {
            if (!ip) return "";
            const parts = ip.split('.');
            if (parts.length >= 3) return `${parts[0]}.${parts[1]}.${parts[2]}`;
            return ip;
        }

        // VPNチェック
        async function verifyConnection() {
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                const myIp = ipData.ip;

                const dnsRes = await fetch(`https://dns.google/resolve?name=${VPN_HOST}&type=A`);
                const dnsData = await dnsRes.json();
                
                let vpnIp = "Unresolved";
                if (dnsData.Answer) vpnIp = dnsData.Answer[0].data;

                const mySubnet = getSubnet(myIp);
                const vpnSubnet = getSubnet(vpnIp);

                if (vpnIp !== "Unresolved" && mySubnet === vpnSubnet) {
                    // VPN OK -> Google認証準備
                    document.getElementById('vpn-checking').style.display = 'none';
                    document.getElementById('auth-request').style.display = 'block';
                    loadGoogleApi();
                } else {
                    // VPN NG
                    document.getElementById('vpn-checking').style.display = 'none';
                    document.getElementById('vpn-error').style.display = 'block';
                    document.getElementById('user-ip').textContent = myIp;
                }
            } catch (error) {
                console.error(error);
                document.getElementById('vpn-checking').style.display = 'none';
                document.getElementById('vpn-error').style.display = 'block';
                document.getElementById('user-ip').textContent = "Error";
            }
        }

        // Google API読み込み
        function loadGoogleApi() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]
                });
                gapiInited = true;
                maybeEnableAuth();
            });
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.error) return;
                    showContent();
                    await listFiles();
                }
            });
            gisInited = true;
            maybeEnableAuth();
        }

        function maybeEnableAuth() {
            // 自動ログイン試行 (トークンがあればスキップ)
            if (gapiInited && gisInited) {
                if (gapi.client.getToken()) {
                    showContent();
                    listFiles();
                }
            }
        }

        function handleAuth() {
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        // コンテンツ表示（ロック解除）
        function showContent() {
            const lock = document.getElementById('vpn-lock-screen');
            const real = document.getElementById('real-content');
            lock.style.opacity = 0;
            setTimeout(() => {
                lock.style.display = 'none';
                real.style.display = 'block';
                setTimeout(() => real.style.opacity = 1, 50);
            }, 500);
        }

        // ドライブファイル一覧取得
        async function listFiles() {
            try {
                const response = await gapi.client.drive.files.list({
                    'pageSize': 20,
                    'fields': "nextPageToken, files(id, name, mimeType, iconLink, webViewLink, modifiedTime, size)",
                    'q': "trashed = false" // ゴミ箱以外
                });
                
                const files = response.result.files;
                const grid = document.getElementById('drive-files');
                grid.innerHTML = '';

                if (files && files.length > 0) {
                    files.forEach(file => {
                        const icon = getIcon(file.mimeType);
                        const color = getColor(file.mimeType);
                        const size = file.size ? formatBytes(file.size) : '';
                        const date = new Date(file.modifiedTime).toLocaleDateString();

                        const card = document.createElement('a');
                        card.className = 'file-card';
                        card.href = file.webViewLink;
                        card.target = '_blank'; // 新しいタブで開く
                        card.innerHTML = `
                            <div class="icon-box"><i class="${icon}" style="color:${color};"></i></div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">${date} ${size ? '• '+size : ''}</div>
                        `;
                        grid.appendChild(card);
                    });
                } else {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">ファイルが見つかりませんでした</div>';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('drive-files').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:red;">エラーが発生しました</div>';
            }
        }

        // アイコンと色のヘルパー
        function getIcon(mime) {
            if(mime.includes('folder')) return 'fa-solid fa-folder';
            if(mime.includes('pdf')) return 'fa-solid fa-file-pdf';
            if(mime.includes('spreadsheet') || mime.includes('excel')) return 'fa-solid fa-file-excel';
            if(mime.includes('document') || mime.includes('word')) return 'fa-solid fa-file-word';
            if(mime.includes('presentation') || mime.includes('powerpoint')) return 'fa-solid fa-file-powerpoint';
            if(mime.includes('image')) return 'fa-solid fa-image';
            return 'fa-solid fa-file';
        }
        function getColor(mime) {
            if(mime.includes('folder')) return '#f0ad4e'; // 黄
            if(mime.includes('pdf')) return '#dc3545'; // 赤
            if(mime.includes('spreadsheet') || mime.includes('excel')) return '#28a745'; // 緑
            if(mime.includes('document') || mime.includes('word')) return '#007bff'; // 青
            if(mime.includes('presentation') || mime.includes('powerpoint')) return '#fd7e14'; // オレンジ
            if(mime.includes('image')) return '#17a2b8'; // 水色
            return '#6c757d'; // グレー
        }
        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }
    </script>
</body>
</html>
