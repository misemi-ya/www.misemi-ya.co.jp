<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Mail | Misemi-ya University</title>
    <!-- Google API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #003366;
            --sidebar-width: 260px;
            --header-height: 60px;
            --bg-color: #f6f8fc;
            --hover-color: #e8eaed;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* ヘッダー */
        header {
            height: var(--header-height); background: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid #e0e0e0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; gap: 15px; font-weight: bold; color: #444; }
        .header-left i { cursor: pointer; color: #5f6368; }
        .user-email { font-size: 0.9rem; color: #666; background: #eee; padding: 5px 15px; border-radius: 20px; }

        /* コンテナ */
        .mail-container { display: flex; flex: 1; overflow: hidden; }

        /* サイドバー */
        .sidebar {
            width: var(--sidebar-width); background: var(--bg-color);
            padding: 15px; display: flex; flex-direction: column; gap: 5px;
            overflow-y: auto;
        }
        
        .btn-compose {
            background: #c2e7ff; color: #001d35; padding: 15px 20px;
            border-radius: 16px; border: none; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 15px; transition: 0.2s;
            margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn-compose:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.15); background: #b3d7ef; }

        /* サイドバーメニュー */
        .menu-section { margin-bottom: 20px; }
        .menu-label { font-size: 0.75rem; color: #5f6368; padding-left: 15px; margin-bottom: 5px; font-weight: bold; }

        .folder-item {
            padding: 8px 20px; border-radius: 0 20px 20px 0; cursor: pointer;
            display: flex; align-items: center; gap: 15px; color: #202124;
            font-size: 0.95rem; text-decoration: none;
        }
        .folder-item i { width: 20px; text-align: center; color: #5f6368; }
        .folder-item:hover { background: #e0e0e0; }
        .folder-item.active { background: #d3e3fd; color: #001d35; font-weight: bold; }
        .folder-item.active i { color: #001d35; }

        /* メインコンテンツ（メールリスト） */
        .content-area {
            flex: 1; background: white; margin: 10px 10px 10px 0;
            border-radius: 16px; display: flex; flex-direction: column;
            overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        .mail-list { overflow-y: auto; flex: 1; }
        
        .mail-item {
            display: grid; grid-template-columns: 220px 1fr 120px;
            padding: 12px 20px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer; align-items: center; transition: background 0.1s;
        }
        .mail-item:hover { box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0, 0 1px 2px 0 rgba(60,64,67,.3); z-index: 1; }
        .mail-item.unread { background: #f2f6fc; font-weight: bold; color: #202124; }
        .mail-item.unread .sender, .mail-item.unread .subject { font-weight: 800; }
        
        .sender { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .subject { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #5f6368; padding-right: 15px; }
        .date { font-size: 0.8rem; text-align: right; color: #5f6368; }

        /* 「さらに読み込む」ボタン */
        .load-more-btn {
            width: 100%; padding: 15px; background: none; border: none;
            color: #0b57d0; cursor: pointer; font-weight: bold; border-top: 1px solid #f0f0f0;
        }
        .load-more-btn:hover { background: #f8f9fa; }

        /* 詳細画面（オーバーレイ） */
        .mail-detail {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 20; display: none; flex-direction: column;
        }
        .detail-toolbar {
            padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;
        }
        .icon-btn { border: none; background: none; cursor: pointer; font-size: 1.1rem; padding: 10px; border-radius: 50%; color: #444; }
        .icon-btn:hover { background: #eee; }

        .detail-content { padding: 40px; overflow-y: auto; flex: 1; }
        .detail-header { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .detail-subject { font-size: 1.4rem; margin-bottom: 15px; }
        .detail-info { display: flex; justify-content: space-between; color: #666; font-size: 0.9rem; }
        .detail-body { line-height: 1.6; font-size: 1rem; color: #222; }

        /* 作成モーダル */
        .compose-modal {
            position: fixed; bottom: 0; right: 80px; width: 500px; height: 600px;
            background: white; box-shadow: 0 0 24px rgba(0,0,0,0.15);
            border-radius: 12px 12px 0 0; z-index: 200;
            display: none; flex-direction: column; overflow: hidden;
        }
        .compose-header {
            background: #f2f2f2; padding: 12px 15px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; color: #444;
        }
        .compose-body { flex: 1; display: flex; flex-direction: column; }
        .compose-input { border: none; border-bottom: 1px solid #eee; padding: 12px; outline: none; font-size: 0.95rem; }
        .compose-textarea { flex: 1; border: none; padding: 15px; outline: none; resize: none; font-family: inherit; font-size: 1rem; }
        .compose-footer { padding: 15px; display: flex; justify-content: flex-start; align-items: center; }
        
        .btn-send {
            background: #0b57d0; color: white; border: none; padding: 10px 24px;
            border-radius: 20px; cursor: pointer; font-weight: bold;
        }
        .btn-send:hover { background: #0946a8; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* 認証オーバーレイ */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .google-signin-btn {
            background: #fff; border: 1px solid #dadce0; color: #3c4043;
            padding: 12px 24px; border-radius: 24px; cursor: pointer;
            font-weight: 500; font-size: 1rem; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .google-signin-btn:hover { background: #f8f9fa; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <!-- 認証オーバーレイ -->
    <div id="auth-overlay">
        <h2 style="color:#444; margin-bottom:10px;">Webメールへようこそ</h2>
        <p style="color:#666; margin-bottom:30px;">Googleアカウントと連携してメールを管理します。</p>
        <button class="google-signin-btn" onclick="handleAuth()">
            <i class="fa-brands fa-google" style="color:#DB4437; font-size:1.2rem;"></i>
            Googleアカウントでログイン
        </button>
    </div>

    <!-- ヘッダー -->
    <header>
        <div class="header-left">
            <a href="l.html" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-arrow-left"></i>
                <img src="../校章.png" alt="logo" onerror="this.style.display='none'" style="height:30px;">
                <span>Misemi-ya Web Mail</span>
            </a>
        </div>
        <div class="user-email" id="user-email">Guest</div>
    </header>

    <div class="mail-container">
        <!-- サイドバー -->
        <aside class="sidebar">
            <button class="btn-compose" onclick="openCompose()">
                <i class="fa-solid fa-pencil" style="font-size:1.2rem;"></i> 作成
            </button>

            <div class="menu-section">
                <div class="menu-label">MAIL BOXES</div>
                <div class="folder-item active" onclick="resetLoad('INBOX')">
                    <i class="fa-solid fa-inbox"></i> 受信トレイ
                </div>
                <div class="folder-item" onclick="resetLoad('SENT')">
                    <i class="fa-regular fa-paper-plane"></i> 送信済み
                </div>
                <div class="folder-item" onclick="resetLoad('TRASH')">
                    <i class="fa-regular fa-trash-can"></i> ゴミ箱
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-label">UNIVERSITY APPS</div>
                <a href="l.html" class="folder-item">
                    <i class="fa-solid fa-chart-pie"></i> ダッシュボード
                </a>
                <a href="reserve.html" class="folder-item">
                    <i class="fa-solid fa-calendar-check"></i> 施設予約
                </a>
                <a href="students.html" class="folder-item">
                    <i class="fa-solid fa-user-graduate"></i> 学生検索
                </a>
            </div>
        </aside>

        <!-- メインコンテンツ -->
        <main class="content-area">
            <!-- メール一覧 -->
            <div id="mail-list" class="mail-list"></div>
            
            <!-- 読み込みボタン -->
            <button id="loadMoreBtn" class="load-more-btn" style="display:none;" onclick="loadMore()">
                さらに読み込む
            </button>
            
            <!-- 詳細ビュー -->
            <div id="mail-detail" class="mail-detail">
                <div class="detail-toolbar">
                    <button class="icon-btn" onclick="closeDetail()" title="戻る"><i class="fa-solid fa-arrow-left"></i></button>
                    <button class="icon-btn" onclick="deleteCurrent()" title="削除"><i class="fa-regular fa-trash-can"></i></button>
                </div>
                <div id="detail-body" class="detail-content"></div>
            </div>
        </main>
    </div>

    <!-- 新規作成モーダル -->
    <div id="compose-modal" class="compose-modal">
        <div class="compose-header">
            <span>新規メッセージ</span>
            <button onclick="closeCompose()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">×</button>
        </div>
        <div class="compose-body">
            <input id="to" class="compose-input" placeholder="To">
            <input id="sub" class="compose-input" placeholder="件名">
            <textarea id="msg" class="compose-textarea" placeholder="本文を入力..."></textarea>
        </div>
        <div class="compose-footer">
            <button onclick="sendMail()" class="btn-send">送信</button>
        </div>
    </div>

    <script>
        // ▼▼▼ Google Client ID ▼▼▼
        const CLIENT_ID = '385803166778-kg041ijpug65vf8ir68tubl8v804ncef.apps.googleusercontent.com';
        
        // 必要なスコープ (Gmailの読み書き・送信)
        const SCOPES = 'https://www.googleapis.com/auth/gmail.modify';

        let tokenClient;
        let nextPageToken = null;
        let currentLabel = 'INBOX';
        let currentMsgId = null;

        // 初期化処理
        window.onload = () => {
            gapi.load('client', async () => {
                await gapi.client.init({
                    discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"]
                });
                
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) {
                            console.error(resp);
                            return;
                        }
                        // 認証成功時
                        document.getElementById('auth-overlay').style.display = 'none';
                        resetLoad('INBOX');
                        loadProfile();
                    }
                });

                // 既にログイン済みかチェックして自動ログイン試行
                const token = gapi.client.getToken();
                if (!token) {
                    // サイレントログインを試みる（以前許可していればポップアップなし）
                    tokenClient.requestAccessToken({prompt: ''});
                } else {
                    document.getElementById('auth-overlay').style.display = 'none';
                    resetLoad('INBOX');
                    loadProfile();
                }
            });
        };

        // ログインボタン押下
        function handleAuth() {
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        // プロフィール取得 (メールアドレス表示用)
        async function loadProfile() {
            try {
                const res = await gapi.client.gmail.users.getProfile({userId: 'me'});
                document.getElementById('user-email').textContent = res.result.emailAddress;
            } catch(e) { console.error(e); }
        }

        // ラベル切り替え・リセット
        function resetLoad(label) {
            currentLabel = label;
            nextPageToken = null;
            document.getElementById('mail-list').innerHTML = '';
            document.getElementById('loadMoreBtn').style.display = 'none';
            
            // アクティブクラスの切り替え
            document.querySelectorAll('.folder-item').forEach(e => e.classList.remove('active'));
            if(event && event.currentTarget) event.currentTarget.classList.add('active');
            
            loadMessages();
        }

        // メッセージ一覧取得
        async function loadMessages() {
            const btn = document.getElementById('loadMoreBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 読み込み中...';
            
            try {
                const res = await gapi.client.gmail.users.messages.list({
                    userId: 'me',
                    labelIds: [currentLabel],
                    maxResults: 20,
                    pageToken: nextPageToken
                });

                nextPageToken = res.result.nextPageToken;
                
                if (res.result.messages) {
                    for (const m of res.result.messages) {
                        // 個別に詳細取得 (Promiseで並列処理も可能だが順番維持のため直列推奨)
                        const detail = await gapi.client.gmail.users.messages.get({userId: 'me', id: m.id});
                        renderItem(detail.result);
                    }
                } else {
                    if(!nextPageToken && document.getElementById('mail-list').children.length === 0) {
                        document.getElementById('mail-list').innerHTML = '<div style="padding:40px; text-align:center; color:#888;">メールはありません</div>';
                    }
                }

                if (nextPageToken) {
                    btn.style.display = 'block';
                    btn.innerHTML = 'さらに読み込む';
                } else {
                    btn.style.display = 'none';
                }

            } catch(e) {
                console.error(e);
                btn.innerHTML = 'エラーが発生しました';
            }
        }

        function loadMore() {
            loadMessages();
        }

        // リストアイテムの描画
        function renderItem(m) {
            const h = m.payload.headers;
            const sub = h.find(x => x.name==='Subject')?.value || '(件名なし)';
            const fromRaw = h.find(x => x.name==='From')?.value || '';
            const from = fromRaw.replace(/<.*>/,'').trim() || fromRaw; // 名前だけ抽出
            const date = new Date(Number(m.internalDate)).toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            const isUnread = m.labelIds.includes('UNREAD');

            const div = document.createElement('div');
            div.className = `mail-item ${isUnread ? 'unread' : ''}`;
            div.innerHTML = `
                <div class="sender">${from}</div>
                <div class="subject">${sub} <span style="font-weight:normal; color:#999; margin-left:10px;">- ${m.snippet}</span></div>
                <div class="date">${date}</div>
            `;
            div.onclick = () => openDetail(m);
            document.getElementById('mail-list').appendChild(div);
        }

        // 詳細画面を開く
        function openDetail(m) {
            currentMsgId = m.id;
            const h = m.payload.headers;
            const sub = h.find(x => x.name==='Subject')?.value || '(件名なし)';
            const from = h.find(x => x.name==='From')?.value || '';
            const date = new Date(Number(m.internalDate)).toLocaleString('ja-JP');

            let body = '';
            // 本文のデコード処理 (HTML優先)
            if(m.payload.parts) {
                const htmlPart = m.payload.parts.find(x => x.mimeType==='text/html');
                const textPart = m.payload.parts.find(x => x.mimeType==='text/plain');
                const p = htmlPart || textPart || m.payload.parts[0];
                if(p.body.data) body = decodeBase64(p.body.data);
            } else if (m.payload.body.data) {
                body = decodeBase64(m.payload.body.data);
            }
            
            const detailHtml = `
                <div class="detail-header">
                    <div class="detail-subject">${sub}</div>
                    <div class="detail-info">
                        <div><strong>From:</strong> ${from}</div>
                        <div>${date}</div>
                    </div>
                </div>
                <div class="detail-body">${body}</div>
            `;

            document.getElementById('detail-body').innerHTML = detailHtml;
            document.getElementById('mail-detail').style.display = 'flex';

            // 既読にする
            if(m.labelIds.includes('UNREAD')) {
                gapi.client.gmail.users.messages.modify({
                    userId: 'me', id: m.id, removeLabelIds: ['UNREAD']
                }).then(() => {
                    // リスト側の未読スタイルを解除したい場合はリロードするかDOM操作が必要
                    // 今回は簡易的にそのまま
                });
            }
        }

        function closeDetail() {
            document.getElementById('mail-detail').style.display = 'none';
        }

        // メール送信
        async function sendMail() {
            const to = document.getElementById('to').value;
            const sub = document.getElementById('sub').value;
            const msg = document.getElementById('msg').value;

            if(!to) { alert('宛先を入力してください'); return; }

            const email = 
                `To: ${to}\r\n` +
                `Subject: ${sub}\r\n` +
                `Content-Type: text/plain; charset=utf-8\r\n\r\n` +
                `${msg}`;

            const raw = btoa(unescape(encodeURIComponent(email))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

            try {
                await gapi.client.gmail.users.messages.send({
                    userId: 'me',
                    resource: { raw: raw }
                });
                alert('送信しました');
                closeCompose();
                // フォームクリア
                document.getElementById('to').value = '';
                document.getElementById('sub').value = '';
                document.getElementById('msg').value = '';
                // 送信済みフォルダにいるならリロード
                if(currentLabel === 'SENT') resetLoad('SENT');
            } catch(e) {
                console.error(e);
                alert('送信に失敗しました');
            }
        }

        // 削除（ゴミ箱へ）
        async function deleteCurrent() {
            if(!confirm('このメールをゴミ箱に移動しますか？')) return;
            try {
                await gapi.client.gmail.users.messages.trash({userId:'me', id:currentMsgId});
                closeDetail();
                // リストを再読み込みして削除を反映
                resetLoad(currentLabel);
            } catch(e) {
                console.error(e);
                alert('削除できませんでした');
            }
        }
        
        // モーダル制御
        function openCompose(){ document.getElementById('compose-modal').style.display='flex'; }
        function closeCompose(){ document.getElementById('compose-modal').style.display='none'; }

        // Base64URLデコード
        function decodeBase64(d){
            return decodeURIComponent(escape(window.atob(d.replace(/-/g,'+').replace(/_/g,'/'))));
        }
    </script>
</body>
</html>
